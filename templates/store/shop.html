{% extends "base.html" %}
{% block title %}Stationery Shop{% endblock %}
{% block content %}
<div class="container py-5">
  <h2 class="mb-5 fw-bold text-center text-gradient">
    âœ¨ Explore Our Stationery Collection âœ¨
  </h2>

  {% for category in categories %}
  <h4 class="mt-5 mb-3 fw-semibold text-dark border-bottom pb-2">
    {{ category.name }}
  </h4>
  <div class="row g-4">
    {% for item in category.items.all %}
    {% if item.status == "active" %}
    <div class="col-sm-6 col-md-4 col-lg-3">
      <div class="card shadow-sm border-0 h-100 rounded-4 overflow-hidden hover-card bg-light bg-gradient">
        <div class="position-relative">
          {% if item.image %}
          <img src="{{ item.image.url }}" class="card-img-top" alt="{{ item.name }}"
            style="height:200px; object-fit:cover;">
          {% else %}
          <img src="https://via.placeholder.com/400x200?text=No+Image" class="card-img-top" alt="{{ item.name }}">
          {% endif %}
          <!-- <span class="price-badge">
                {{ item.price }} Tk
              </span> -->
          <span class="badge bg-success position-absolute top-0 end-0 m-2 px-3 py-2">
            {{ item.price }} Tk
          </span>
        </div>
        <div class="card-body d-flex flex-column">
          <h5 class="card-title fw-bold text-truncate">{{ item.name }}</h5>
          <p class="card-text text-muted small mb-3" style="min-height: 40px;">
            {{ item.description|truncatewords:12 }}
          </p>
          <div class="mt-auto">
            <!-- <a href="{% url 'order_item' item.id %}" class="btn btn-gradient w-100 fw-semibold">
                  ðŸ›’ Order Now
                </a> -->
            <div class="mt-auto">
              <a href="{% url 'add_to_cart' item.id %}" class="btn btn-gradient w-100 fw-semibold btn-add-to-cart">
                ðŸ›’ Add to Cart
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    {% empty %}
    <p class="text-muted">No items in this category.</p>
    {% endfor %}
  </div>
  {% endfor %}
</div>

<style>
  /* Fancy gradient title */
  .text-gradient {
    background: linear-gradient(90deg, #0d6efd, #20c997, #ff5722);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* Smooth hover effect */
  .hover-card {
    transition: transform 0.25s ease, box-shadow 0.25s ease;
  }

  .hover-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  }

  /* Fancy price ribbon */
  .price-badge {
    position: absolute;
    top: 12px;
    right: -25px;
    background: linear-gradient(135deg, #20c997, #0dcaf0);
    color: white;
    padding: 6px 40px;
    font-size: 0.9rem;
    font-weight: bold;
    transform: rotate(45deg);
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
  }

  /* Gradient button */
  .btn-gradient {
    background: linear-gradient(90deg, #0d6efd, #6610f2, #2261ff);
    color: #fff;
    border: none;
    transition: background 0.3s ease, transform 0.2s ease;
    border-radius: 50px;
  }

  .btn-gradient:hover {
    background: linear-gradient(90deg, #ff5722, #6610f2, #0d6efd);
    transform: scale(1.05);
    color: #fff;
  }
</style>
{% block 1_extra_js %} <script>
document.addEventListener('DOMContentLoaded', function() {
    
    // 1. Find all our 'Add to Cart' buttons
    const addButtons = document.querySelectorAll('.btn-add-to-cart');
    
    addButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            // 2. Stop the link from reloading the page
            e.preventDefault(); 
            
            const url = this.href;
            const originalText = this.innerHTML;
            
            // 3. Show a temporary "Adding..." state
            this.innerHTML = 'Adding...';
            this.disabled = true;

            // 4. Send the request in the background
            fetch(url, {
                method: 'GET',
                headers: {
                    // This header tells our view it's an AJAX request
                    'X-Requested-With': 'XMLHttpRequest' 
                }
            })
            .then(response => response.json())
            .then(data => {
                // 5. Success! We got the JSON data from the view
                if (data.success) {
                    // Update the cart bubble
                    updateCartBubble(data.new_cart_count);
                    
                    // Show success on the button
                    this.innerHTML = 'âœ… Added!';
                    
                    // Reset button after a moment
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }, 1500);
                }
            })
            .catch(error => {
                console.error('Error adding to cart:', error);
                this.innerHTML = 'Error!';
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.disabled = false;
                }, 2000);
            });
        });
    });

    // 6. This function updates the bubble in base.html
    function updateCartBubble(count) {
        let bubble = document.querySelector('.cart-bubble');
        if (!bubble) return; // Failsafe

        let badge = bubble.querySelector('.cart-badge');
        
        if (count > 0) {
            if (!badge) {
                // If the badge doesn't exist (count was 0), create it
                badge = document.createElement('span');
                badge.className = 'cart-badge';
                bubble.appendChild(badge);
            }
            badge.textContent = count;
        } else {
            // If the count is 0, remove the badge
            if (badge) {
                badge.remove();
            }
        }
    }
});
</script>
{% endblock 1_extra_js %}

{% endblock %}

